name: dotfiles CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    name: Test on Ubuntu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup CI dependencies
        run: |
          set -e
          echo "ğŸ” Starting CI dependencies setup..."
          
          # Create local bin directory
          mkdir -p ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV
          
          # Install chezmoi
          echo "ğŸ“¦ Installing chezmoi..."
          curl -fsLS get.chezmoi.io | sh -s -- -b ~/.local/bin
          echo "âœ… chezmoi installed to ~/.local/bin"
          
          # Install dependencies
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y age shellcheck
          echo "âœ… System dependencies installed"
          
          # Install Neovim latest stable
          echo "ğŸ“¦ Installing Neovim..."
          NVIM_VERSION="v0.11.1"
          NVIM_URL="https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz"
          echo "Downloading from: $NVIM_URL"
          curl -L --fail --show-error "$NVIM_URL" -o nvim-linux-x86_64.tar.gz
          echo "File downloaded, checking content type:"
          file nvim-linux-x86_64.tar.gz
          tar -C ~/.local -xzf nvim-linux-x86_64.tar.gz
          ln -sf ~/.local/nvim-linux-x86_64/bin/nvim ~/.local/bin/nvim
          rm nvim-linux-x86_64.tar.gz
          echo "âœ… Neovim installed to ~/.local/bin"
          
          # Install stylua (Lua formatter)
          echo "ğŸ“¦ Installing StyLua..."
          STYLUA_VERSION="v2.1.0"
          STYLUA_URL="https://github.com/JohnnyMorganz/StyLua/releases/download/${STYLUA_VERSION}/stylua-linux-x86_64.zip"
          echo "Downloading from: $STYLUA_URL"
          curl -L --fail --show-error "$STYLUA_URL" -o stylua.zip
          echo "File downloaded, checking content type:"
          file stylua.zip
          unzip stylua.zip
          chmod +x stylua
          mv stylua ~/.local/bin/
          rm stylua.zip
          echo "âœ… StyLua installed to ~/.local/bin"
          
          # Verify installations
          echo "ğŸ”§ Verifying installations..."
          ls -la ~/.local/bin/
          echo "PATH: $PATH"

      - name: Install Security Tools
        run: |
          set -e
          echo "ğŸ”’ Installing security tools..."
          
          # Install GitLeaks
          echo "ğŸ“¦ Installing GitLeaks..."
          GITLEAKS_VERSION="v8.21.0"
          GITLEAKS_URL="https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_8.21.0_linux_x64.tar.gz"
          curl -L --fail --show-error "$GITLEAKS_URL" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz
          mv gitleaks ~/.local/bin/
          rm gitleaks.tar.gz
          echo "âœ… GitLeaks installed to ~/.local/bin"
          
          # Install TruffleHog
          echo "ğŸ“¦ Installing TruffleHog..."
          TRUFFLEHOG_VERSION="v3.63.2"
          TRUFFLEHOG_URL="https://github.com/trufflesecurity/trufflehog/releases/download/${TRUFFLEHOG_VERSION}/trufflehog_3.63.2_linux_amd64.tar.gz"
          curl -L --fail --show-error "$TRUFFLEHOG_URL" -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          mv trufflehog ~/.local/bin/
          rm trufflehog.tar.gz
          echo "âœ… TruffleHog installed to ~/.local/bin"
          
          # Verify security tools
          echo "ğŸ”§ Verifying security tools..."
          ls -la ~/.local/bin/
          echo "ğŸ‰ All security tools installed successfully"

      - name: Run comprehensive CI checks
        env:
          CI: true
        run: |
          set -e
          echo "ğŸ” Running comprehensive CI checks..."
          
          # PATHè¨­å®šã‚’ç¢ºå®Ÿã«
          export PATH="$HOME/.local/bin:$PATH"
          echo "Current PATH: $PATH"
          echo "Home directory: $HOME"
          echo "Contents of ~/.local/bin:"
          ls -la ~/.local/bin/ || echo "~/.local/bin directory not found"
          
          # ãƒ„ãƒ¼ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ”§ Checking installed tools..."
          which chezmoi && chezmoi --version || echo "âŒ chezmoi not found"
          which shellcheck && shellcheck --version || echo "âŒ shellcheck not found"  
          which stylua && stylua --version || echo "âŒ stylua not found"
          which nvim && nvim --version | head -1 || echo "âŒ nvim not found"
          which gitleaks && gitleaks version || echo "âŒ gitleaks not found"
          which trufflehog && trufflehog --version || echo "âŒ trufflehog not found"
          
          # åŸºæœ¬çš„ãªCIãƒã‚§ãƒƒã‚¯
          chmod +x scripts/ci-check.sh
          scripts/ci-check.sh
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          echo "ğŸ”’ Running security checks..."
          make security-check || echo "âš ï¸ Security checks completed with warnings"

  test-macos:
    runs-on: macos-latest
    name: Test on macOS

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup dependencies with make install
        env:
          CI: true
        run: |
          set -e
          echo "ğŸš€ Using make install for setup..."
          # Homebrewã¯æ—¢ã«åˆ©ç”¨å¯èƒ½
          make install

      - name: Run comprehensive CI checks
        env:
          CI: true
        run: |
          set -e
          echo "ğŸ” Running comprehensive CI checks..."
          make ci-check
