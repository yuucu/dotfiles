name: dotfiles CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    name: Test on Ubuntu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup CI dependencies
        run: |
          set -e
          echo "ğŸ” Starting CI dependencies setup..."
          
          # Install chezmoi
          echo "ğŸ“¦ Installing chezmoi..."
          curl -fsLS get.chezmoi.io | sh -s -- -b "$HOME/bin"
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "âœ… chezmoi installed"
          
          # Install dependencies
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y age shellcheck
          echo "âœ… System dependencies installed"
          
          # Install Neovim latest stable
          echo "ğŸ“¦ Installing Neovim..."
          NVIM_VERSION="v0.11.1"
          NVIM_URL="https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz"
          echo "Downloading from: $NVIM_URL"
          curl -L --fail --show-error "$NVIM_URL" -o nvim-linux-x86_64.tar.gz
          echo "File downloaded, checking content type:"
          file nvim-linux-x86_64.tar.gz
          sudo tar -C /opt -xzf nvim-linux-x86_64.tar.gz
          sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
          rm nvim-linux-x86_64.tar.gz
          echo "âœ… Neovim installed"
          
          # Install stylua (Lua formatter)
          echo "ğŸ“¦ Installing StyLua..."
          STYLUA_VERSION="v2.1.0"
          STYLUA_URL="https://github.com/JohnnyMorganz/StyLua/releases/download/${STYLUA_VERSION}/stylua-linux-x86_64.zip"
          echo "Downloading from: $STYLUA_URL"
          curl -L --fail --show-error "$STYLUA_URL" -o stylua.zip
          echo "File downloaded, checking content type:"
          file stylua.zip
          unzip stylua.zip
          chmod +x stylua
          sudo mv stylua /usr/local/bin/
          rm stylua.zip
          echo "âœ… StyLua installed"

      - name: Install Security Tools
        run: |
          set -e
          echo "ğŸ”’ Installing security tools..."
          
          # Install GitLeaks
          echo "ğŸ“¦ Installing GitLeaks..."
          GITLEAKS_VERSION="v8.21.0"
          GITLEAKS_URL="https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_8.21.0_linux_x64.tar.gz"
          curl -L --fail --show-error "$GITLEAKS_URL" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz
          mkdir -p ~/.local/bin
          mv gitleaks ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          rm gitleaks.tar.gz
          echo "âœ… GitLeaks installed"
          
          # Install TruffleHog
          echo "ğŸ“¦ Installing TruffleHog..."
          TRUFFLEHOG_VERSION="v3.63.2"
          TRUFFLEHOG_URL="https://github.com/trufflesecurity/trufflehog/releases/download/${TRUFFLEHOG_VERSION}/trufflehog_3.63.2_linux_amd64.tar.gz"
          curl -L --fail --show-error "$TRUFFLEHOG_URL" -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          mv trufflehog ~/.local/bin/
          rm trufflehog.tar.gz
          echo "âœ… TruffleHog installed"
          
          echo "ğŸ‰ All security tools installed successfully"

      - name: Run comprehensive CI checks
        env:
          CI: true
        run: |
          set -e
          echo "ğŸ” Running comprehensive CI checks..."
          
          # åŸºæœ¬çš„ãªCIãƒã‚§ãƒƒã‚¯
          chmod +x scripts/ci-check.sh
          scripts/ci-check.sh
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          echo "ğŸ”’ Running security checks..."
          make security-check-all || echo "âš ï¸ Security checks completed with warnings"

  test-macos:
    runs-on: macos-latest
    name: Test on macOS

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup dependencies with make install
        env:
          CI: true
        run: |
          set -e
          echo "ğŸš€ Using make install for setup..."
          # Homebrewã¯æ—¢ã«åˆ©ç”¨å¯èƒ½
          make install

      - name: Run comprehensive CI checks
        env:
          CI: true
        run: |
          set -e
          echo "ğŸ” Running comprehensive CI checks..."
          make ci-check
