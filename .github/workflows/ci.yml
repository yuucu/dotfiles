name: dotfiles CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    name: Test on Ubuntu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup CI dependencies
        run: |
          set -e
          echo "üîç Starting CI dependencies setup..."
          
          # Create local bin directory
          mkdir -p ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV
          
          # Install chezmoi
          echo "üì¶ Installing chezmoi..."
          curl -fsLS get.chezmoi.io | sh -s -- -b ~/.local/bin
          echo "‚úÖ chezmoi installed to ~/.local/bin"
          
          # Install dependencies
          echo "üì¶ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y age shellcheck
          echo "‚úÖ System dependencies installed"
          
          # Install Neovim latest stable
          echo "üì¶ Installing Neovim..."
          NVIM_VERSION="v0.11.1"
          NVIM_URL="https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz"
          echo "Downloading from: $NVIM_URL"
          curl -L --fail --show-error "$NVIM_URL" -o nvim-linux-x86_64.tar.gz
          echo "File downloaded, checking content type:"
          file nvim-linux-x86_64.tar.gz
          tar -C ~/.local -xzf nvim-linux-x86_64.tar.gz
          ln -sf ~/.local/nvim-linux-x86_64/bin/nvim ~/.local/bin/nvim
          rm nvim-linux-x86_64.tar.gz
          echo "‚úÖ Neovim installed to ~/.local/bin"
          
          # Install stylua (Lua formatter)
          echo "üì¶ Installing StyLua..."
          STYLUA_VERSION="v2.1.0"
          STYLUA_URL="https://github.com/JohnnyMorganz/StyLua/releases/download/${STYLUA_VERSION}/stylua-linux-x86_64.zip"
          echo "Downloading from: $STYLUA_URL"
          curl -L --fail --show-error "$STYLUA_URL" -o stylua.zip
          echo "File downloaded, checking content type:"
          file stylua.zip
          unzip stylua.zip
          chmod +x stylua
          mv stylua ~/.local/bin/
          rm stylua.zip
          echo "‚úÖ StyLua installed to ~/.local/bin"
          
          # Verify installations
          echo "üîß Verifying installations..."
          ls -la ~/.local/bin/
          echo "PATH: $PATH"

      - name: Install Security Tools
        run: |
          set -e
          echo "üîí Installing security tools..."
          
          # Install GitLeaks
          echo "üì¶ Installing GitLeaks..."
          GITLEAKS_VERSION="v8.21.0"
          GITLEAKS_URL="https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_8.21.0_linux_x64.tar.gz"
          curl -L --fail --show-error "$GITLEAKS_URL" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz
          mv gitleaks ~/.local/bin/
          rm gitleaks.tar.gz
          echo "‚úÖ GitLeaks installed to ~/.local/bin"
          
          # Install TruffleHog
          echo "üì¶ Installing TruffleHog..."
          TRUFFLEHOG_VERSION="v3.63.2"
          TRUFFLEHOG_URL="https://github.com/trufflesecurity/trufflehog/releases/download/${TRUFFLEHOG_VERSION}/trufflehog_3.63.2_linux_amd64.tar.gz"
          curl -L --fail --show-error "$TRUFFLEHOG_URL" -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          mv trufflehog ~/.local/bin/
          rm trufflehog.tar.gz
          echo "‚úÖ TruffleHog installed to ~/.local/bin"
          
          # Verify security tools
          echo "üîß Verifying security tools..."
          ls -la ~/.local/bin/
          echo "üéâ All security tools installed successfully"

      - name: Run comprehensive CI checks
        env:
          CI: true
        run: |
          set -e
          echo "üîç Running comprehensive CI checks..."
          
          # PATHË®≠ÂÆö„ÇíÁ¢∫ÂÆü„Å´
          export PATH="$HOME/.local/bin:$PATH"
          echo "Current PATH: $PATH"
          echo "Home directory: $HOME"
          echo "Contents of ~/.local/bin:"
          ls -la ~/.local/bin/ || echo "~/.local/bin directory not found"
          
          # „ÉÑ„Éº„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          echo "üîß Checking installed tools..."
          which chezmoi && chezmoi --version || echo "‚ùå chezmoi not found"
          which shellcheck && shellcheck --version || echo "‚ùå shellcheck not found"  
          which stylua && stylua --version || echo "‚ùå stylua not found"
          which nvim && nvim --version | head -1 || echo "‚ùå nvim not found"
          which gitleaks && gitleaks version || echo "‚ùå gitleaks not found"
          which trufflehog && trufflehog --version || echo "‚ùå trufflehog not found"
          
          # Âü∫Êú¨ÁöÑ„Å™CI„ÉÅ„Çß„ÉÉ„ÇØ
          chmod +x scripts/ci-check.sh
          scripts/ci-check.sh
          
          # „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
          echo "üîí Running security checks..."
          make security-check || echo "‚ö†Ô∏è Security checks completed with warnings"
